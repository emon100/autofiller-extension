<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OneFillr Interactive Demo v2</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes toastIn { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes toastOut { from { opacity: 1; } to { opacity: 0; transform: translateX(100px); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    
    .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
    .animate-slideIn { animation: slideIn 0.3s ease-out; }
    .animate-toastIn { animation: toastIn 0.3s ease-out; }
    .animate-toastOut { animation: toastOut 0.3s ease-out forwards; }
    .animate-pulse { animation: pulse 2s infinite; }
    
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 3px; }
    
    .field-wrapper { position: relative; }
    .field-wrapper:hover .clear-btn { opacity: 1; }
    .clear-btn { opacity: 0; transition: opacity 0.2s; }
    
    .field-badge { position: absolute; right: -8px; top: 50%; transform: translateY(-50%) translateX(100%); z-index: 10; white-space: nowrap; }
    .badge-filled { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
    .badge-suggest { background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
    .badge-sensitive { background: #fef3c7; color: #92400e; border: 1px solid #fcd34d; }
    .badge-pending { background: #f3f4f6; color: #6b7280; border: 1px solid #d1d5db; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="mode-toggle" class="fixed top-4 right-4 z-[200]">
    <button onclick="toggleDemoMode()" class="px-3 py-2 text-xs font-medium bg-white border border-gray-300 rounded-lg shadow-sm hover:bg-gray-50 flex items-center gap-2">
      <svg id="toggle-icon-expand" class="w-4 h-4 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg>
      <svg id="toggle-icon-collapse" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 9V4.5M9 9H4.5M9 9L3.5 3.5M9 15v4.5M9 15H4.5M9 15l-5.5 5.5M15 9h4.5M15 9V4.5M15 9l5.5-5.5M15 15h4.5M15 15v4.5m0-4.5l5.5 5.5"/></svg>
      <span id="toggle-text">Form Only</span>
    </button>
  </div>

  <div id="main-container" class="flex h-screen">
    <div id="left-panel" class="w-80 bg-white border-r border-gray-200 flex flex-col">
      <div class="p-4 border-b border-gray-100">
        <h1 class="text-lg font-bold text-gray-800 flex items-center gap-2">
          <span class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
            </svg>
          </span>
          OneFillr Demo v2
        </h1>
        <p class="text-xs text-gray-500 mt-1">Two-Phase Save + Synonym Tests</p>
      </div>

      <!-- Test Profiles -->
      <div class="p-4 border-b border-gray-100">
        <h2 class="text-sm font-semibold text-gray-700 mb-2">Quick Initialize</h2>
        <div class="flex gap-2 flex-wrap">
          <button onclick="loadProfile('us')" class="px-3 py-1.5 text-xs rounded-lg border border-gray-200 hover:border-blue-400 hover:bg-blue-50">US Applicant</button>
          <button onclick="loadProfile('cn')" class="px-3 py-1.5 text-xs rounded-lg border border-gray-200 hover:border-blue-400 hover:bg-blue-50">CN Applicant</button>
          <button onclick="loadProfile('intl')" class="px-3 py-1.5 text-xs rounded-lg border border-gray-200 hover:border-blue-400 hover:bg-blue-50">International</button>
        </div>
        <div class="flex gap-2 mt-2">
          <button onclick="exportAnswers()" class="text-xs text-gray-500 hover:text-blue-600">Export</button>
          <button onclick="importAnswers()" class="text-xs text-gray-500 hover:text-blue-600">Import</button>
          <button onclick="clearAllAnswers()" class="text-xs text-red-400 hover:text-red-600">Clear All</button>
        </div>
      </div>

      <!-- Form Templates -->
      <div class="p-4 border-b border-gray-100">
        <h2 class="text-sm font-semibold text-gray-700 mb-2">Form Templates</h2>
        <div class="space-y-1.5 max-h-64 overflow-y-auto custom-scrollbar pr-1">
          <button onclick="loadTemplate('synonym-name')" class="template-btn w-full px-3 py-2 text-left text-xs rounded-lg border border-gray-200 hover:border-blue-300 hover:bg-blue-50" data-template="synonym-name">
            <span class="font-medium">Synonym: Name Split</span>
            <span class="text-gray-400 block">Full name vs First+Last</span>
          </button>
          <button onclick="loadTemplate('synonym-date')" class="template-btn w-full px-3 py-2 text-left text-xs rounded-lg border border-gray-200 hover:border-blue-300 hover:bg-blue-50" data-template="synonym-date">
            <span class="font-medium">Synonym: Date Format</span>
            <span class="text-gray-400 block">Date picker vs Select vs Text</span>
          </button>
          <button onclick="loadTemplate('synonym-phone')" class="template-btn w-full px-3 py-2 text-left text-xs rounded-lg border border-gray-200 hover:border-blue-300 hover:bg-blue-50" data-template="synonym-phone">
            <span class="font-medium">Synonym: Phone Format</span>
            <span class="text-gray-400 block">E.164 vs Local vs Split</span>
          </button>
          <button onclick="loadTemplate('phone-country-split')" class="template-btn w-full px-3 py-2 text-left text-xs rounded-lg border border-green-300 hover:border-green-500 hover:bg-green-50" data-template="phone-country-split">
            <span class="font-medium">Phone + Country Code</span>
            <span class="text-green-500 block">Country code separation test</span>
          </button>
          <button onclick="loadTemplate('synonym-bool')" class="template-btn w-full px-3 py-2 text-left text-xs rounded-lg border border-gray-200 hover:border-blue-300 hover:bg-blue-50" data-template="synonym-bool">
            <span class="font-medium">Synonym: Yes/No</span>
            <span class="text-gray-400 block">Radio vs Checkbox vs Select</span>
          </button>
          <button onclick="loadTemplate('synonym-email')" class="template-btn w-full px-3 py-2 text-left text-xs rounded-lg border border-gray-200 hover:border-blue-300 hover:bg-blue-50" data-template="synonym-email">
            <span class="font-medium">Synonym: Email</span>
            <span class="text-gray-400 block">Email type vs Text</span>
          </button>
          <button onclick="loadTemplate('synonym-location')" class="template-btn w-full px-3 py-2 text-left text-xs rounded-lg border border-gray-200 hover:border-blue-300 hover:bg-blue-50" data-template="synonym-location">
            <span class="font-medium">Synonym: Location</span>
            <span class="text-gray-400 block">City text vs Select</span>
          </button>
          <button onclick="loadTemplate('synonym-links')" class="template-btn w-full px-3 py-2 text-left text-xs rounded-lg border border-gray-200 hover:border-blue-300 hover:bg-blue-50" data-template="synonym-links">
            <span class="font-medium">Synonym: Links</span>
            <span class="text-gray-400 block">LinkedIn/GitHub/Portfolio</span>
          </button>
          <button onclick="loadTemplate('synonym-education')" class="template-btn w-full px-3 py-2 text-left text-xs rounded-lg border border-gray-200 hover:border-blue-300 hover:bg-blue-50" data-template="synonym-education">
            <span class="font-medium">Synonym: Education</span>
            <span class="text-gray-400 block">School/Degree/Major variations</span>
          </button>
          <button onclick="loadTemplate('all-fields')" class="template-btn w-full px-3 py-2 text-left text-xs rounded-lg border border-purple-300 bg-purple-50 text-purple-700" data-template="all-fields">
            <span class="font-medium">All Field Types</span>
            <span class="text-purple-400 block">Comprehensive coverage</span>
          </button>
          <button onclick="loadTemplate('full')" class="template-btn w-full px-3 py-2 text-left text-xs rounded-lg border border-blue-500 bg-blue-50 text-blue-700" data-template="full">
            <span class="font-medium">Full Application</span>
            <span class="text-blue-400 block">Complete job form</span>
          </button>
        </div>
      </div>

      <!-- Saved Answers -->
      <div class="flex-1 overflow-y-auto custom-scrollbar p-4">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-sm font-semibold text-gray-700">Saved Answers</h2>
          <span id="answer-count" class="text-xs text-gray-400">0 items</span>
        </div>
        <div id="answers-editor" class="space-y-2"></div>
      </div>

      <!-- Controls -->
      <div class="p-4 border-t border-gray-100 space-y-2">
        <div class="flex items-center justify-between text-sm">
          <span class="text-gray-600">Two-Phase Save</span>
          <span class="text-xs px-2 py-0.5 bg-green-100 text-green-700 rounded">Active</span>
        </div>
        <div class="flex items-center justify-between text-sm">
          <span class="text-gray-600">Pending Fields</span>
          <span id="pending-count" class="text-xs px-2 py-0.5 bg-amber-100 text-amber-700 rounded">0</span>
        </div>
      </div>
    </div>

    <!-- Center: Form Area -->
    <div class="flex-1 overflow-y-auto custom-scrollbar p-6 bg-gray-50">
      <div class="max-w-2xl mx-auto">
        <!-- Pending Notice -->
        <div id="pending-notice" class="hidden mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg text-sm text-amber-800">
          <strong>Pending:</strong> <span id="pending-fields-text">0 fields</span> detected. Click <strong>Submit</strong> to save permanently.
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h2 id="form-title" class="text-lg font-bold text-gray-800">Job Application</h2>
              <p id="form-subtitle" class="text-sm text-gray-500">Test Form</p>
            </div>
            <div class="text-sm text-gray-400"><span id="field-count">0</span> fields</div>
          </div>
          <form id="demo-form" class="space-y-5" onsubmit="handleFormSubmit(event)"></form>
          
          <div class="mt-6 pt-4 border-t border-gray-100 flex justify-between">
            <button type="button" onclick="clearForm()" class="px-4 py-2 text-sm text-gray-600 border border-gray-200 rounded-lg hover:bg-gray-50">
              Clear Form
            </button>
            <button type="submit" form="demo-form" class="px-6 py-2 text-sm text-white bg-blue-600 rounded-lg hover:bg-blue-700">
              Submit (Save Answers)
            </button>
          </div>
        </div>

        <div id="stats-panel" class="mt-4 bg-white rounded-xl shadow-sm border border-gray-200 p-4">
          <div class="grid grid-cols-4 gap-4 text-center">
            <div>
              <p id="stat-scanned" class="text-xl font-bold text-blue-600">0</p>
              <p class="text-xs text-gray-500">Scanned</p>
            </div>
            <div>
              <p id="stat-filled" class="text-xl font-bold text-green-600">0</p>
              <p class="text-xs text-gray-500">Filled</p>
            </div>
            <div>
              <p id="stat-transformed" class="text-xl font-bold text-purple-600">0</p>
              <p class="text-xs text-gray-500">Transformed</p>
            </div>
            <div>
              <p id="stat-time" class="text-xl font-bold text-gray-600">0ms</p>
              <p class="text-xs text-gray-500">Time</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="right-panel" class="w-80 bg-white border-l border-gray-200 flex flex-col">
      <!-- Tabs -->
      <div class="flex border-b border-gray-100 overflow-x-auto">
        <button onclick="switchSideTab('database')" class="side-tab active flex-shrink-0 px-3 py-2.5 text-xs font-medium border-b-2 transition-colors text-blue-600 border-blue-600 bg-blue-50/50" data-tab="database">
          Local Knowledge
        </button>
        <button onclick="switchSideTab('activity')" class="side-tab flex-shrink-0 px-3 py-2.5 text-xs font-medium border-b-2 transition-colors text-gray-500 hover:text-gray-700 hover:bg-gray-50 border-transparent" data-tab="activity">
          Activity
        </button>
        <button onclick="switchSideTab('settings')" class="side-tab flex-shrink-0 px-3 py-2.5 text-xs font-medium border-b-2 transition-colors text-gray-500 hover:text-gray-700 hover:bg-gray-50 border-transparent" data-tab="settings">
          Settings
        </button>
      </div>

      <!-- Database Tab -->
      <div id="tab-database" class="side-tab-content flex-1 overflow-y-auto custom-scrollbar">
        <div class="p-3">
          <!-- Search -->
          <div class="relative mb-3">
            <input type="text" id="db-search" placeholder="Search..." class="w-full px-3 py-2 pl-9 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" oninput="filterDatabaseItems()">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
          </div>

          <!-- Summary Stats -->
          <div class="grid grid-cols-3 gap-2 mb-3">
            <div class="bg-blue-50 rounded-lg p-2 text-center">
              <p id="stat-answers" class="text-lg font-bold text-blue-600">0</p>
              <p class="text-[10px] text-blue-500">Answers</p>
            </div>
            <div class="bg-green-50 rounded-lg p-2 text-center">
              <p id="stat-work" class="text-lg font-bold text-green-600">0</p>
              <p class="text-[10px] text-green-500">Work Exp</p>
            </div>
            <div class="bg-purple-50 rounded-lg p-2 text-center">
              <p id="stat-edu" class="text-lg font-bold text-purple-600">0</p>
              <p class="text-[10px] text-purple-500">Education</p>
            </div>
          </div>

          <!-- Database Items -->
          <div id="database-items" class="space-y-2"></div>
        </div>
      </div>

      <!-- Activity Tab -->
      <div id="tab-activity" class="side-tab-content flex-1 overflow-y-auto custom-scrollbar hidden">
        <div class="p-3 border-b border-gray-100 flex items-center justify-between">
          <span class="text-sm font-medium text-gray-700">Recent Activity</span>
          <button onclick="clearLogs()" class="text-xs text-gray-400 hover:text-gray-600">Clear</button>
        </div>
        <div id="activity-log" class="p-3 space-y-2"></div>
      </div>

      <!-- Settings Tab -->
      <div id="tab-settings" class="side-tab-content flex-1 overflow-y-auto custom-scrollbar hidden">
        <div class="p-4 space-y-4">
          <!-- Account Section -->
          <div class="bg-gray-50 rounded-lg p-4">
            <h3 class="text-sm font-semibold text-gray-700 mb-2">Account</h3>
            <p class="text-xs text-gray-500 mb-3">Sign in to use AI enhancement features.</p>
            <button class="w-full px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">
              Sign In
            </button>
          </div>

          <!-- AI Enhancement -->
          <div class="border border-gray-200 rounded-lg p-4">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium text-gray-700">AI Enhancement</span>
              <button id="ai-toggle" onclick="toggleAiEnhancement()" class="relative inline-flex h-5 w-9 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out bg-gray-200">
                <span class="pointer-events-none inline-block h-4 w-4 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out translate-x-0"></span>
              </button>
            </div>
            <p class="text-xs text-gray-500">Use AI to better recognize complex form fields</p>
          </div>

          <!-- Typing Animation -->
          <div class="border border-gray-200 rounded-lg p-4">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium text-gray-700">Typing Animation</span>
              <button id="anim-toggle" onclick="toggleTypingAnimation()" class="relative inline-flex h-5 w-9 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out bg-blue-600">
                <span class="pointer-events-none inline-block h-4 w-4 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out translate-x-4"></span>
              </button>
            </div>
            <p class="text-xs text-gray-500">Show typewriter effect when filling forms</p>
          </div>

          <!-- Privacy -->
          <div class="border border-gray-200 rounded-lg p-4">
            <h3 class="text-sm font-semibold text-gray-700 mb-2">Privacy & Data</h3>
            <p class="text-xs text-gray-500 mb-3">All data is stored locally on your device.</p>
            <a href="#" class="text-xs text-blue-600 hover:underline">View Privacy Policy</a>
          </div>

          <!-- About -->
          <div class="text-center text-xs text-gray-400 pt-2">
            OneFillr Demo v2.0
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="demo-floating-widget" class="fixed bottom-6 right-80 z-50">
    <div class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden">
      <div class="flex items-center">
        <button onclick="handleSaveNow()" class="px-4 py-3 text-sm font-medium text-gray-700 hover:bg-gray-50 flex items-center gap-2 border-r border-gray-100">
          <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
          Save Now
        </button>
        <button onclick="handleFill()" class="px-4 py-3 text-sm font-medium text-white bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
          Fill
        </button>
      </div>
    </div>
    <div class="flex justify-end mt-2">
      <button onclick="handleUndo()" id="btn-undo" class="text-xs text-gray-400 hover:text-blue-600 hidden">Undo</button>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container" class="fixed bottom-6 right-6 z-[100] space-y-2" style="width: 300px;"></div>

  <script>
    // ==================== CONSTANTS ====================
    const Taxonomy = {
      FULL_NAME: 'FULL_NAME', FIRST_NAME: 'FIRST_NAME', LAST_NAME: 'LAST_NAME',
      EMAIL: 'EMAIL', PHONE: 'PHONE', COUNTRY_CODE: 'COUNTRY_CODE',
      CITY: 'CITY', LOCATION: 'LOCATION', LINKEDIN: 'LINKEDIN', GITHUB: 'GITHUB', PORTFOLIO: 'PORTFOLIO',
      SCHOOL: 'SCHOOL', DEGREE: 'DEGREE', MAJOR: 'MAJOR',
      GRAD_DATE: 'GRAD_DATE', GRAD_YEAR: 'GRAD_YEAR', GRAD_MONTH: 'GRAD_MONTH',
      WORK_AUTH: 'WORK_AUTH', NEED_SPONSORSHIP: 'NEED_SPONSORSHIP',
      EEO_GENDER: 'EEO_GENDER', EEO_ETHNICITY: 'EEO_ETHNICITY',
      UNKNOWN: 'UNKNOWN'
    };

    const SENSITIVE_TYPES = new Set([Taxonomy.EEO_GENDER, Taxonomy.EEO_ETHNICITY]);
    const CONFIDENCE_THRESHOLD = 0.75;

    // ==================== TEST PROFILES ====================
    const PROFILES = {
      us: {
        [Taxonomy.FULL_NAME]: { value: 'John Michael Doe', display: 'John Michael Doe' },
        [Taxonomy.FIRST_NAME]: { value: 'John', display: 'John' },
        [Taxonomy.LAST_NAME]: { value: 'Doe', display: 'Doe' },
        [Taxonomy.EMAIL]: { value: 'john.doe@gmail.com', display: 'john.doe@gmail.com' },
        [Taxonomy.PHONE]: { value: '+14155551234', display: '+1 (415) 555-1234' },
        [Taxonomy.COUNTRY_CODE]: { value: '+1', display: '+1' },
        [Taxonomy.CITY]: { value: 'San Francisco', display: 'San Francisco' },
        [Taxonomy.LOCATION]: { value: 'San Francisco, CA', display: 'San Francisco, CA' },
        [Taxonomy.LINKEDIN]: { value: 'https://linkedin.com/in/johndoe', display: 'linkedin.com/in/johndoe' },
        [Taxonomy.GITHUB]: { value: 'https://github.com/johndoe', display: 'github.com/johndoe' },
        [Taxonomy.PORTFOLIO]: { value: 'https://johndoe.dev', display: 'johndoe.dev' },
        [Taxonomy.SCHOOL]: { value: 'Stanford University', display: 'Stanford University' },
        [Taxonomy.DEGREE]: { value: "Master's", display: "Master's Degree" },
        [Taxonomy.MAJOR]: { value: 'Computer Science', display: 'Computer Science' },
        [Taxonomy.GRAD_DATE]: { value: '2024-05-15', display: 'May 2024' },
        [Taxonomy.GRAD_YEAR]: { value: '2024', display: '2024' },
        [Taxonomy.GRAD_MONTH]: { value: '05', display: 'May' },
        [Taxonomy.WORK_AUTH]: { value: 'yes', display: 'Yes' },
        [Taxonomy.NEED_SPONSORSHIP]: { value: 'no', display: 'No' },
      },
      cn: {
        [Taxonomy.FULL_NAME]: { value: '张三', display: '张三' },
        [Taxonomy.FIRST_NAME]: { value: '三', display: '三' },
        [Taxonomy.LAST_NAME]: { value: '张', display: '张' },
        [Taxonomy.EMAIL]: { value: 'zhangsan@qq.com', display: 'zhangsan@qq.com' },
        [Taxonomy.PHONE]: { value: '+8613812345678', display: '+86 138 1234 5678' },
        [Taxonomy.COUNTRY_CODE]: { value: '+86', display: '+86' },
        [Taxonomy.CITY]: { value: '北京', display: '北京' },
        [Taxonomy.LOCATION]: { value: '北京, 中国', display: '北京, 中国' },
        [Taxonomy.LINKEDIN]: { value: 'https://linkedin.com/in/zhangsan', display: 'linkedin.com/in/zhangsan' },
        [Taxonomy.GITHUB]: { value: 'https://github.com/zhangsan', display: 'github.com/zhangsan' },
        [Taxonomy.PORTFOLIO]: { value: 'https://zhangsan.cn', display: 'zhangsan.cn' },
        [Taxonomy.SCHOOL]: { value: '清华大学', display: '清华大学' },
        [Taxonomy.DEGREE]: { value: '硕士', display: '硕士' },
        [Taxonomy.MAJOR]: { value: '计算机科学', display: '计算机科学' },
        [Taxonomy.GRAD_DATE]: { value: '2024-06-30', display: '2024年6月' },
        [Taxonomy.GRAD_YEAR]: { value: '2024', display: '2024' },
        [Taxonomy.GRAD_MONTH]: { value: '06', display: '6月' },
        [Taxonomy.WORK_AUTH]: { value: 'yes', display: '是' },
        [Taxonomy.NEED_SPONSORSHIP]: { value: 'yes', display: '是' },
      },
      intl: {
        [Taxonomy.FULL_NAME]: { value: 'Amit Patel', display: 'Amit Patel' },
        [Taxonomy.FIRST_NAME]: { value: 'Amit', display: 'Amit' },
        [Taxonomy.LAST_NAME]: { value: 'Patel', display: 'Patel' },
        [Taxonomy.EMAIL]: { value: 'amit@university.edu', display: 'amit@university.edu' },
        [Taxonomy.PHONE]: { value: '+919876543210', display: '+91 98765 43210' },
        [Taxonomy.COUNTRY_CODE]: { value: '+91', display: '+91' },
        [Taxonomy.CITY]: { value: 'Mumbai', display: 'Mumbai' },
        [Taxonomy.LOCATION]: { value: 'Mumbai, India', display: 'Mumbai, India' },
        [Taxonomy.LINKEDIN]: { value: 'https://linkedin.com/in/amitpatel', display: 'linkedin.com/in/amitpatel' },
        [Taxonomy.GITHUB]: { value: 'https://github.com/amitpatel', display: 'github.com/amitpatel' },
        [Taxonomy.PORTFOLIO]: { value: 'https://amitpatel.io', display: 'amitpatel.io' },
        [Taxonomy.SCHOOL]: { value: 'IIT Delhi', display: 'IIT Delhi' },
        [Taxonomy.DEGREE]: { value: "Bachelor's", display: "Bachelor's" },
        [Taxonomy.MAJOR]: { value: 'Electrical Engineering', display: 'Electrical Engineering' },
        [Taxonomy.GRAD_DATE]: { value: '2023-05-01', display: 'May 2023' },
        [Taxonomy.GRAD_YEAR]: { value: '2023', display: '2023' },
        [Taxonomy.GRAD_MONTH]: { value: '05', display: 'May' },
        [Taxonomy.WORK_AUTH]: { value: 'no', display: 'No' },
        [Taxonomy.NEED_SPONSORSHIP]: { value: 'yes', display: 'Yes' },
      }
    };

    // ==================== TEMPLATES ====================
    const TEMPLATES = {
      'synonym-name': {
        title: 'Name Format Test',
        subtitle: 'Full name vs First+Last split',
        fields: [
          { name: 'fullName', label: 'Full Name', type: 'text', taxonomy: Taxonomy.FULL_NAME },
          { name: 'firstName', label: 'First Name', type: 'text', taxonomy: Taxonomy.FIRST_NAME },
          { name: 'lastName', label: 'Last Name', type: 'text', taxonomy: Taxonomy.LAST_NAME },
          { name: 'givenName', label: 'Given Name (Same as First)', type: 'text', taxonomy: Taxonomy.FIRST_NAME },
          { name: 'familyName', label: 'Family Name (Same as Last)', type: 'text', taxonomy: Taxonomy.LAST_NAME },
        ]
      },
      'synonym-date': {
        title: 'Date Format Test',
        subtitle: 'Different date input methods',
        fields: [
          { name: 'gradDate', label: 'Graduation Date (Date Picker)', type: 'date', taxonomy: Taxonomy.GRAD_DATE },
          { name: 'gradMonth', label: 'Graduation Month (Month Picker)', type: 'month', taxonomy: Taxonomy.GRAD_DATE },
          { name: 'gradYearSelect', label: 'Graduation Year', type: 'select', options: ['', '2022', '2023', '2024', '2025', '2026'], taxonomy: Taxonomy.GRAD_YEAR },
          { name: 'gradMonthSelect', label: 'Graduation Month', type: 'select', options: ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'], taxonomy: Taxonomy.GRAD_MONTH },
          { name: 'gradText', label: 'Graduation (Text: MM/YYYY)', type: 'text', placeholder: '05/2024', taxonomy: Taxonomy.GRAD_DATE },
          { name: 'gradMonthShort', label: 'Graduation Month (Short)', type: 'select', options: ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'], taxonomy: Taxonomy.GRAD_MONTH },
          { name: 'gradMonthNumeric', label: 'Graduation Month (Numeric)', type: 'select', options: ['', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'], taxonomy: Taxonomy.GRAD_MONTH },
          { name: 'gradMonthPadded', label: 'Graduation Month (Padded)', type: 'select', options: ['', '01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'], taxonomy: Taxonomy.GRAD_MONTH },
        ]
      },
      'synonym-phone': {
        title: 'Phone Format Test',
        subtitle: 'Different phone input methods',
        fields: [
          { name: 'phoneE164', label: 'Phone (E.164: +14155551234)', type: 'tel', taxonomy: Taxonomy.PHONE },
          { name: 'phoneLocal', label: 'Phone (Local: 4155551234)', type: 'tel', maxlength: '10', taxonomy: Taxonomy.PHONE },
          { name: 'phoneFormatted', label: 'Phone (Formatted)', type: 'tel', placeholder: '(415) 555-1234', taxonomy: Taxonomy.PHONE },
          { name: 'countryCode', label: 'Country Code', type: 'select', options: ['', '+1 (US)', '+86 (CN)', '+91 (IN)', '+44 (UK)'], taxonomy: Taxonomy.COUNTRY_CODE },
          { name: 'phoneNumber', label: 'Phone Number (without country)', type: 'tel', taxonomy: Taxonomy.PHONE },
          { name: 'phoneDashes', label: 'Phone (Dashes: 415-555-1234)', type: 'tel', placeholder: '555-555-5555', taxonomy: Taxonomy.PHONE },
        ]
      },
      'phone-country-split': {
        title: 'Phone + Country Code Test',
        subtitle: 'Country code separation scenarios',
        sections: [
          { title: 'Section A — Phone Only (no Country Code field)', fields: [
            { name: 'phoneOnly', label: 'Phone', type: 'tel', taxonomy: Taxonomy.PHONE },
          ]},
          { title: 'Section B — Phone + Country Code Split', fields: [
            { name: 'countryCodeB', label: 'Country Code', type: 'select', options: ['', '+1', '+86', '+91', '+44'], taxonomy: Taxonomy.COUNTRY_CODE },
            { name: 'phoneB', label: 'Phone Number', type: 'tel', taxonomy: Taxonomy.PHONE },
          ]},
          { title: 'Section C — Various Formats + Country Code', fields: [
            { name: 'countryCodeC', label: 'Country Code', type: 'select', options: ['', '+1', '+86', '+91', '+44'], taxonomy: Taxonomy.COUNTRY_CODE },
            { name: 'phoneCLocal', label: 'Phone (maxlength=10)', type: 'tel', maxlength: '10', taxonomy: Taxonomy.PHONE },
            { name: 'phoneCParens', label: 'Phone (parentheses)', type: 'tel', placeholder: '(555) 555-5555', taxonomy: Taxonomy.PHONE },
            { name: 'phoneCDashes', label: 'Phone (dashes)', type: 'tel', placeholder: '555-555-5555', taxonomy: Taxonomy.PHONE },
          ]},
        ]
      },
      'synonym-bool': {
        title: 'Boolean/Choice Test',
        subtitle: 'Yes/No in different formats',
        fields: [
          { name: 'workAuthRadio', label: 'Authorized to work? (Radio)', type: 'radio', options: ['Yes', 'No'], taxonomy: Taxonomy.WORK_AUTH },
          { name: 'workAuthSelect', label: 'Work Authorization (Select)', type: 'select', options: ['', 'Yes', 'No'], taxonomy: Taxonomy.WORK_AUTH },
          { name: 'workAuthCheck', label: 'I am authorized to work in this country', type: 'checkbox', taxonomy: Taxonomy.WORK_AUTH },
          { name: 'sponsorRadio', label: 'Need visa sponsorship?', type: 'radio', options: ['Yes', 'No'], taxonomy: Taxonomy.NEED_SPONSORSHIP },
          { name: 'sponsorSelect', label: 'Sponsorship Required', type: 'select', options: ['', 'Yes, I need sponsorship', 'No, I do not need sponsorship'], taxonomy: Taxonomy.NEED_SPONSORSHIP },
          { name: 'workAuthChinese', label: 'Work Authorization (Chinese)', type: 'select', options: ['', '是', '否'], taxonomy: Taxonomy.WORK_AUTH },
        ]
      },
      'synonym-email': {
        title: 'Email Format Test',
        subtitle: 'Different email input methods',
        fields: [
          { name: 'emailStandard', label: 'Email Address', type: 'email', taxonomy: Taxonomy.EMAIL },
          { name: 'emailText', label: 'Email (Text Input)', type: 'text', placeholder: 'your@email.com', taxonomy: Taxonomy.EMAIL },
          { name: 'contactEmail', label: 'Contact Email', type: 'email', taxonomy: Taxonomy.EMAIL },
          { name: 'workEmail', label: 'Work Email', type: 'email', taxonomy: Taxonomy.EMAIL },
        ]
      },
      'synonym-location': {
        title: 'Location Format Test',
        subtitle: 'Different location/address input methods',
        fields: [
          { name: 'city', label: 'City', type: 'text', taxonomy: Taxonomy.CITY },
          { name: 'citySelect', label: 'City (Select)', type: 'select', options: ['', 'San Francisco', 'New York', 'Los Angeles', 'Beijing', 'London'], taxonomy: Taxonomy.CITY },
          { name: 'location', label: 'Location (City, State/Country)', type: 'text', placeholder: 'San Francisco, CA', taxonomy: Taxonomy.LOCATION },
          { name: 'currentCity', label: 'Current City', type: 'text', taxonomy: Taxonomy.CITY },
          { name: 'preferredLocation', label: 'Preferred Work Location', type: 'text', taxonomy: Taxonomy.CITY },
        ]
      },
      'synonym-links': {
        title: 'Links & URLs Test',
        subtitle: 'Different social/portfolio link formats',
        fields: [
          { name: 'linkedin', label: 'LinkedIn Profile URL', type: 'url', placeholder: 'https://linkedin.com/in/yourname', taxonomy: Taxonomy.LINKEDIN },
          { name: 'linkedinText', label: 'LinkedIn (Text)', type: 'text', placeholder: 'linkedin.com/in/yourname', taxonomy: Taxonomy.LINKEDIN },
          { name: 'github', label: 'GitHub URL', type: 'url', placeholder: 'https://github.com/username', taxonomy: Taxonomy.GITHUB },
          { name: 'githubText', label: 'GitHub Username', type: 'text', placeholder: 'username', taxonomy: Taxonomy.GITHUB },
          { name: 'portfolio', label: 'Portfolio Website', type: 'url', taxonomy: Taxonomy.PORTFOLIO },
          { name: 'personalWebsite', label: 'Personal Website', type: 'text', placeholder: 'yoursite.com', taxonomy: Taxonomy.PORTFOLIO },
        ]
      },
      'synonym-education': {
        title: 'Education Fields Test',
        subtitle: 'Different education input formats',
        fields: [
          { name: 'school', label: 'School/University Name', type: 'text', taxonomy: Taxonomy.SCHOOL },
          { name: 'university', label: 'University', type: 'text', taxonomy: Taxonomy.SCHOOL },
          { name: 'collegeName', label: 'College Name', type: 'text', taxonomy: Taxonomy.SCHOOL },
          { name: 'degree', label: 'Degree', type: 'select', options: ['', "Bachelor's", "Master's", 'Ph.D.', 'Associate', 'High School'], taxonomy: Taxonomy.DEGREE },
          { name: 'degreeText', label: 'Degree (Text)', type: 'text', placeholder: "Bachelor's, Master's, etc.", taxonomy: Taxonomy.DEGREE },
          { name: 'educationLevel', label: 'Highest Education Level', type: 'select', options: ['', 'High School', "Bachelor's Degree", "Master's Degree", 'Doctorate'], taxonomy: Taxonomy.DEGREE },
          { name: 'major', label: 'Major/Field of Study', type: 'text', taxonomy: Taxonomy.MAJOR },
          { name: 'fieldOfStudy', label: 'Field of Study', type: 'text', taxonomy: Taxonomy.MAJOR },
          { name: 'concentration', label: 'Concentration', type: 'text', taxonomy: Taxonomy.MAJOR },
          { name: 'degreeChinese', label: 'Degree (Chinese)', type: 'select', options: ['', '本科', '硕士', '博士'], taxonomy: Taxonomy.DEGREE },
        ]
      },
      'all-fields': {
        title: 'All Field Types Test',
        subtitle: 'Comprehensive field type coverage',
        sections: [
          { title: 'Personal Info', fields: [
            { name: 'fullName', label: 'Full Name', type: 'text', required: true, taxonomy: Taxonomy.FULL_NAME },
            { name: 'firstName', label: 'First Name', type: 'text', taxonomy: Taxonomy.FIRST_NAME },
            { name: 'lastName', label: 'Last Name', type: 'text', taxonomy: Taxonomy.LAST_NAME },
            { name: 'email', label: 'Email', type: 'email', required: true, taxonomy: Taxonomy.EMAIL },
            { name: 'phone', label: 'Phone Number', type: 'tel', taxonomy: Taxonomy.PHONE },
            { name: 'city', label: 'City', type: 'text', taxonomy: Taxonomy.CITY },
            { name: 'location', label: 'Location', type: 'text', taxonomy: Taxonomy.LOCATION },
          ]},
          { title: 'Online Presence', fields: [
            { name: 'linkedin', label: 'LinkedIn', type: 'url', taxonomy: Taxonomy.LINKEDIN },
            { name: 'github', label: 'GitHub', type: 'url', taxonomy: Taxonomy.GITHUB },
            { name: 'portfolio', label: 'Portfolio', type: 'url', taxonomy: Taxonomy.PORTFOLIO },
          ]},
          { title: 'Education', fields: [
            { name: 'school', label: 'School', type: 'text', taxonomy: Taxonomy.SCHOOL },
            { name: 'degree', label: 'Degree', type: 'select', options: ['', "Bachelor's", "Master's", 'Ph.D.'], taxonomy: Taxonomy.DEGREE },
            { name: 'major', label: 'Major', type: 'text', taxonomy: Taxonomy.MAJOR },
            { name: 'gradYear', label: 'Graduation Year', type: 'select', options: ['', '2020', '2021', '2022', '2023', '2024', '2025', '2026'], taxonomy: Taxonomy.GRAD_YEAR },
            { name: 'gradMonth', label: 'Graduation Month', type: 'select', options: ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'], taxonomy: Taxonomy.GRAD_MONTH },
            { name: 'gradDate', label: 'Graduation Date', type: 'date', taxonomy: Taxonomy.GRAD_DATE },
          ]},
          { title: 'Work Authorization', fields: [
            { name: 'workAuth', label: 'Authorized to work?', type: 'radio', options: ['Yes', 'No'], taxonomy: Taxonomy.WORK_AUTH },
            { name: 'sponsorship', label: 'Require sponsorship?', type: 'radio', options: ['Yes', 'No'], taxonomy: Taxonomy.NEED_SPONSORSHIP },
          ]},
          { title: 'EEO (Sensitive)', fields: [
            { name: 'gender', label: 'Gender', type: 'select', options: ['', 'Male', 'Female', 'Non-binary', 'Prefer not to say'], taxonomy: Taxonomy.EEO_GENDER },
            { name: 'ethnicity', label: 'Ethnicity', type: 'select', options: ['', 'Asian', 'Black', 'Hispanic', 'White', 'Other', 'Prefer not to say'], taxonomy: Taxonomy.EEO_ETHNICITY },
          ]},
        ]
      },
      'full': {
        title: 'Full Job Application',
        subtitle: 'Complete application form',
        sections: [
          { title: 'Personal Information', fields: [
            { name: 'fullName', label: 'Full Name', type: 'text', required: true, taxonomy: Taxonomy.FULL_NAME },
            { name: 'email', label: 'Email', type: 'email', required: true, taxonomy: Taxonomy.EMAIL },
            { name: 'phone', label: 'Phone', type: 'tel', taxonomy: Taxonomy.PHONE },
            { name: 'city', label: 'City', type: 'text', taxonomy: Taxonomy.CITY },
            { name: 'linkedin', label: 'LinkedIn URL', type: 'url', taxonomy: Taxonomy.LINKEDIN },
          ]},
          { title: 'Education', fields: [
            { name: 'school', label: 'School/University', type: 'text', taxonomy: Taxonomy.SCHOOL },
            { name: 'degree', label: 'Degree', type: 'select', options: ['', "Bachelor's", "Master's", 'Ph.D.'], taxonomy: Taxonomy.DEGREE },
            { name: 'major', label: 'Major', type: 'text', taxonomy: Taxonomy.MAJOR },
            { name: 'gradDate', label: 'Graduation Date', type: 'month', taxonomy: Taxonomy.GRAD_DATE },
          ]},
          { title: 'Work Authorization', fields: [
            { name: 'workAuth', label: 'Legally authorized to work?', type: 'radio', options: ['Yes', 'No'], taxonomy: Taxonomy.WORK_AUTH },
            { name: 'sponsorship', label: 'Require sponsorship?', type: 'radio', options: ['Yes', 'No'], taxonomy: Taxonomy.NEED_SPONSORSHIP },
          ]},
        ]
      }
    };

    // ==================== STATE ====================
    let savedAnswers = {};
    let pendingObservations = [];
    let fillHistory = [];

    // ==================== STORAGE ====================
    function loadAnswers() {
      try {
        savedAnswers = JSON.parse(localStorage.getItem('autofiller_v2_answers') || '{}');
      } catch { savedAnswers = {}; }
      renderAnswersEditor();
    }

    function saveAnswers() {
      localStorage.setItem('autofiller_v2_answers', JSON.stringify(savedAnswers));
      renderAnswersEditor();
    }

    function loadProfile(profileName) {
      const profile = PROFILES[profileName];
      if (!profile) return;
      
      for (const [type, data] of Object.entries(profile)) {
        savedAnswers[type] = {
          id: Date.now().toString() + Math.random().toString(36).slice(2),
          type,
          ...data,
          aliases: [],
          sensitivity: SENSITIVE_TYPES.has(type) ? 'sensitive' : 'normal',
          autofillAllowed: !SENSITIVE_TYPES.has(type),
        };
      }
      saveAnswers();
      showToast(`Loaded ${profileName.toUpperCase()} profile`, 'success');
      logActivity('profile', { name: profileName, count: Object.keys(profile).length });
    }

    function exportAnswers() {
      const data = JSON.stringify(savedAnswers, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'autofiller-answers.json';
      a.click();
      showToast('Exported answers', 'info');
    }

    function importAnswers() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              savedAnswers = JSON.parse(e.target.result);
              saveAnswers();
              showToast('Imported answers', 'success');
            } catch {
              showToast('Invalid JSON file', 'error');
            }
          };
          reader.readAsText(file);
        }
      };
      input.click();
    }

    function clearAllAnswers() {
      if (confirm('Clear all saved answers?')) {
        savedAnswers = {};
        saveAnswers();
        showToast('Cleared all answers', 'info');
      }
    }

    // ==================== VALUE TRANSFORMERS ====================
    const MONTH_NAMES = ['January', 'February', 'March', 'April', 'May', 'June',
      'July', 'August', 'September', 'October', 'November', 'December'];
    const MONTH_SHORT = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
      'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    function transformValue(sourceValue, sourceType, targetField) {
      if (!sourceValue) return sourceValue;

      // Name transformations
      if (sourceType === Taxonomy.FULL_NAME) {
        const isChinese = /[\u4e00-\u9fa5]/.test(sourceValue);
        if (targetField.taxonomy === Taxonomy.FIRST_NAME) {
          return isChinese ? sourceValue.slice(1) : sourceValue.split(/\s+/)[0];
        }
        if (targetField.taxonomy === Taxonomy.LAST_NAME) {
          return isChinese ? sourceValue.charAt(0) : sourceValue.split(/\s+/).pop();
        }
      }

      // Merge first+last to full name
      if ((sourceType === Taxonomy.FIRST_NAME || sourceType === Taxonomy.LAST_NAME) && 
          targetField.taxonomy === Taxonomy.FULL_NAME) {
        const first = savedAnswers[Taxonomy.FIRST_NAME]?.value || '';
        const last = savedAnswers[Taxonomy.LAST_NAME]?.value || '';
        const isChinese = /[\u4e00-\u9fa5]/.test(first) || /[\u4e00-\u9fa5]/.test(last);
        return isChinese ? `${last}${first}` : `${first} ${last}`.trim();
      }

      // Date transformations
      if ([Taxonomy.GRAD_DATE, Taxonomy.GRAD_YEAR, Taxonomy.GRAD_MONTH].includes(sourceType)) {
        const dateMatch = sourceValue.match(/(\d{4})[-\/]?(\d{2})?[-\/]?(\d{2})?/);
        if (dateMatch) {
          const [, year, month, day] = dateMatch;
          
          if (targetField.taxonomy === Taxonomy.GRAD_YEAR || targetField.type === 'select' && /year/i.test(targetField.label)) {
            return year;
          }
          if (targetField.taxonomy === Taxonomy.GRAD_MONTH) {
            if (targetField.type === 'select' && targetField.options) {
              const monthNum = parseInt(month || '1');
              const fullName = MONTH_NAMES[monthNum - 1];
              const shortName = MONTH_SHORT[monthNum - 1];
              const opts = targetField.options.filter(o => o);
              // Try full month name
              if (opts.includes(fullName)) return fullName;
              // Try short month name
              if (opts.includes(shortName)) return shortName;
              // Try unpadded numeric
              if (opts.includes(String(monthNum))) return String(monthNum);
              // Try padded numeric
              const padded = String(monthNum).padStart(2, '0');
              if (opts.includes(padded)) return padded;
              return fullName || month;
            }
            return month || '01';
          }
          if (targetField.type === 'date') {
            return `${year}-${month || '01'}-${day || '01'}`;
          }
          if (targetField.type === 'month') {
            return `${year}-${month || '01'}`;
          }
        }
      }

      // Phone transformations
      if (sourceType === Taxonomy.PHONE || sourceType === Taxonomy.COUNTRY_CODE) {
        const cleaned = sourceValue.replace(/[\s\-\(\)\.]/g, '');
        const match = cleaned.match(/^\+?(\d{1,3})?(\d{10,11})$/);
        
        if (match) {
          const [, countryCode, number] = match;
          
          if (targetField.taxonomy === Taxonomy.COUNTRY_CODE) {
            return countryCode ? `+${countryCode}` : '+1';
          }
          
          if (targetField.maxlength === '10') {
            return number.slice(-10);
          }
          
          if (targetField.placeholder?.includes('(')) {
            const n = number.slice(-10);
            return `(${n.slice(0,3)}) ${n.slice(3,6)}-${n.slice(6)}`;
          }

          if (targetField.placeholder && /\d{3}-\d{3}-\d{4}/.test(targetField.placeholder)) {
            const n = number.slice(-10);
            return `${n.slice(0,3)}-${n.slice(3,6)}-${n.slice(6)}`;
          }
        }
      }

      // Boolean transformations
      if ([Taxonomy.WORK_AUTH, Taxonomy.NEED_SPONSORSHIP].includes(sourceType)) {
        const normalized = sourceValue.toLowerCase();
        const isTrue = ['yes', 'true', '1', '是'].includes(normalized);
        
        if (targetField.type === 'checkbox') {
          return isTrue ? 'true' : 'false';
        }
        
        if (targetField.options) {
          for (const opt of targetField.options) {
            const optLower = opt.toLowerCase();
            if (isTrue && (optLower.includes('yes') || optLower.includes('authorized') || optLower === '是')) {
              return opt;
            }
            if (!isTrue && (optLower.includes('no') || optLower.includes('not') || optLower === '否')) {
              return opt;
            }
          }
        }
        
        return isTrue ? 'Yes' : 'No';
      }

      // Degree transformations
      if (sourceType === Taxonomy.DEGREE && targetField.options) {
        const degreeMap = {
          "bachelor's": ["bachelor", "bs", "ba", "本科"],
          "master's": ["master", "ms", "ma", "硕士"],
          "ph.d.": ["phd", "doctorate", "博士"],
        };
        
        const normalized = sourceValue.toLowerCase();
        for (const [key, aliases] of Object.entries(degreeMap)) {
          if (key === normalized || aliases.some(a => normalized.includes(a))) {
            for (const opt of targetField.options) {
              const optLower = opt.toLowerCase();
              if (optLower.includes(key) || aliases.some(a => optLower.includes(a))) {
                return opt;
              }
            }
          }
        }
      }

      return sourceValue;
    }

    // ==================== STRIP COUNTRY CODE ====================
    function stripCountryCode(phoneValue) {
      const cleaned = phoneValue.replace(/[\s\-\(\)\.]/g, '');
      if (!cleaned.startsWith('+')) return phoneValue;
      const digits = cleaned.slice(1);
      const knownCodes = {
        '1': [10], '7': [10], '44': [10], '86': [11], '91': [10],
        '81': [10,11], '82': [10,11], '49': [10,11], '33': [9], '61': [9],
        '852': [8], '886': [9],
      };
      for (const codeLen of [3, 2, 1]) {
        if (digits.length <= codeLen) continue;
        const code = digits.slice(0, codeLen);
        const rest = digits.slice(codeLen);
        if (knownCodes[code]) return rest;
      }
      return phoneValue;
    }

    // ==================== CLASSIFIER ====================
    const CLASSIFY_RULES = [
      { patterns: [/full.?name/i, /^name$/i], type: Taxonomy.FULL_NAME, score: 0.9 },
      { patterns: [/first.?name|given.?name/i], type: Taxonomy.FIRST_NAME, score: 0.9 },
      { patterns: [/last.?name|family.?name|surname/i], type: Taxonomy.LAST_NAME, score: 0.9 },
      { patterns: [/e.?mail/i], type: Taxonomy.EMAIL, score: 0.9 },
      { patterns: [/phone|mobile|tel/i], type: Taxonomy.PHONE, score: 0.9 },
      { patterns: [/country.?code/i], type: Taxonomy.COUNTRY_CODE, score: 0.85 },
      { patterns: [/city/i], type: Taxonomy.CITY, score: 0.85 },
      { patterns: [/location/i], type: Taxonomy.LOCATION, score: 0.8 },
      { patterns: [/linkedin/i], type: Taxonomy.LINKEDIN, score: 0.95 },
      { patterns: [/github/i], type: Taxonomy.GITHUB, score: 0.95 },
      { patterns: [/portfolio|personal.?website/i], type: Taxonomy.PORTFOLIO, score: 0.9 },
      { patterns: [/school|university|college/i], type: Taxonomy.SCHOOL, score: 0.9 },
      { patterns: [/degree|education.?level/i], type: Taxonomy.DEGREE, score: 0.85 },
      { patterns: [/major|field.?of.?study|concentration/i], type: Taxonomy.MAJOR, score: 0.85 },
      { patterns: [/grad.*year/i], type: Taxonomy.GRAD_YEAR, score: 0.85 },
      { patterns: [/grad.*month/i], type: Taxonomy.GRAD_MONTH, score: 0.85 },
      { patterns: [/grad|graduation/i], type: Taxonomy.GRAD_DATE, score: 0.8 },
      { patterns: [/authorized|work.?auth/i], type: Taxonomy.WORK_AUTH, score: 0.9 },
      { patterns: [/sponsor|visa/i], type: Taxonomy.NEED_SPONSORSHIP, score: 0.9 },
    ];

    function classifyField(element, fieldDef) {
      if (fieldDef?.taxonomy) {
        return { type: fieldDef.taxonomy, score: 1.0, reason: 'explicit taxonomy' };
      }
      
      const name = element.name || '';
      const label = element.closest('.field-wrapper')?.querySelector('label')?.textContent || '';
      const combined = `${name} ${label}`.toLowerCase();
      
      for (const rule of CLASSIFY_RULES) {
        for (const pattern of rule.patterns) {
          if (pattern.test(combined)) {
            return { type: rule.type, score: rule.score, reason: `matches "${pattern.source}"` };
          }
        }
      }
      
      return { type: Taxonomy.UNKNOWN, score: 0, reason: 'no match' };
    }

    // ==================== TWO-PHASE SAVE ====================
    function trackPendingObservation(element, value, fieldDef) {
      const classification = classifyField(element, fieldDef);
      if (classification.type === Taxonomy.UNKNOWN) return;
      
      const existing = pendingObservations.findIndex(p => p.fieldName === element.name);
      if (existing >= 0) {
        pendingObservations[existing].value = value;
        pendingObservations[existing].timestamp = Date.now();
      } else {
        pendingObservations.push({
          id: Date.now().toString(),
          fieldName: element.name,
          type: classification.type,
          value,
          timestamp: Date.now(),
        });
      }
      
      updatePendingUI();
      showBadge(element, 'pending');
    }

    function commitPendingObservations() {
      let committed = 0;
      
      for (const obs of pendingObservations) {
        if (!obs.value) continue;
        
        savedAnswers[obs.type] = {
          id: obs.id,
          type: obs.type,
          value: obs.value,
          display: obs.value,
          aliases: [],
          sensitivity: SENSITIVE_TYPES.has(obs.type) ? 'sensitive' : 'normal',
          autofillAllowed: !SENSITIVE_TYPES.has(obs.type),
        };
        committed++;
      }
      
      if (committed > 0) {
        saveAnswers();
        showToast(`Saved ${committed} answers`, 'success');
        logActivity('commit', { count: committed });
      }
      
      pendingObservations = [];
      updatePendingUI();
      removeBadges('pending');
    }

    function updatePendingUI() {
      const count = pendingObservations.length;
      document.getElementById('pending-count').textContent = count;
      
      const notice = document.getElementById('pending-notice');
      if (count > 0) {
        notice.classList.remove('hidden');
        document.getElementById('pending-fields-text').textContent = `${count} field${count > 1 ? 's' : ''}`;
      } else {
        notice.classList.add('hidden');
      }
    }

    function handleFormSubmit(event) {
      event.preventDefault();
      commitPendingObservations();
    }

    function handleSaveNow() {
      commitPendingObservations();
    }

    // ==================== FILL LOGIC ====================
    async function handleFill() {
      const startTime = performance.now();
      const form = document.getElementById('demo-form');
      const elements = form.querySelectorAll('input, select, textarea');
      
      let filledCount = 0;
      let transformedCount = 0;
      fillHistory = [];
      
      removeBadges();

      // Detect if any field is classified as COUNTRY_CODE
      const hasCountryCodeField = Array.from(elements).some(el => {
        const c = classifyField(el, el._fieldDef);
        return c.type === Taxonomy.COUNTRY_CODE;
      });

      for (const element of elements) {
        const fieldDef = element._fieldDef;
        const classification = classifyField(element, fieldDef);
        
        if (classification.type === Taxonomy.UNKNOWN) continue;
        
        // Find matching answer (try exact match first, then related types)
        let answer = savedAnswers[classification.type];
        let sourceType = classification.type;
        let transformed = false;
        
        if (!answer) {
          // Try to find related answer for transformation
          const relatedTypes = getRelatedTypes(classification.type);
          for (const relatedType of relatedTypes) {
            if (savedAnswers[relatedType]) {
              answer = savedAnswers[relatedType];
              sourceType = relatedType;
              break;
            }
          }
        }
        
        if (!answer) continue;
        
        if (SENSITIVE_TYPES.has(classification.type) && !answer.autofillAllowed) {
          showBadge(element, 'sensitive', [answer]);
          continue;
        }
        
        if (classification.score < CONFIDENCE_THRESHOLD) {
          showBadge(element, 'suggest', [answer]);
          continue;
        }
        
        // Transform value if needed
        let valueToFill = answer.value;
        if (sourceType !== classification.type || fieldDef) {
          const transformedValue = transformValue(answer.value, sourceType, fieldDef || { taxonomy: classification.type, type: element.type });
          if (transformedValue !== answer.value) {
            valueToFill = transformedValue;
            transformed = true;
            transformedCount++;
          }
        }

        // Strip country code from phone when a dedicated COUNTRY_CODE field exists
        if (hasCountryCodeField && classification.type === Taxonomy.PHONE) {
          const stripped = stripCountryCode(valueToFill);
          if (stripped !== valueToFill) {
            valueToFill = stripped;
            if (!transformed) {
              transformed = true;
              transformedCount++;
            }
          }
        }
        
        const snapshot = { element, previousValue: element.value || element.checked };
        const success = fillField(element, valueToFill);
        
        if (success) {
          fillHistory.push(snapshot);
          filledCount++;
          showBadge(element, transformed ? 'transformed' : 'filled');
        }
        
        await new Promise(r => setTimeout(r, 10));
      }
      
      const elapsed = Math.round(performance.now() - startTime);
      
      document.getElementById('stat-scanned').textContent = elements.length;
      document.getElementById('stat-filled').textContent = filledCount;
      document.getElementById('stat-transformed').textContent = transformedCount;
      document.getElementById('stat-time').textContent = elapsed + 'ms';
      
      if (filledCount > 0) {
        document.getElementById('btn-undo').classList.remove('hidden');
      }
      
      showToast(`Filled ${filledCount} fields (${transformedCount} transformed)`, 'success');
      logActivity('fill', { filled: filledCount, transformed: transformedCount, time: elapsed });
    }

    function getRelatedTypes(type) {
      const relations = {
        [Taxonomy.FULL_NAME]: [Taxonomy.FIRST_NAME, Taxonomy.LAST_NAME],
        [Taxonomy.FIRST_NAME]: [Taxonomy.FULL_NAME],
        [Taxonomy.LAST_NAME]: [Taxonomy.FULL_NAME],
        [Taxonomy.GRAD_DATE]: [Taxonomy.GRAD_YEAR, Taxonomy.GRAD_MONTH],
        [Taxonomy.GRAD_YEAR]: [Taxonomy.GRAD_DATE],
        [Taxonomy.GRAD_MONTH]: [Taxonomy.GRAD_DATE],
        [Taxonomy.PHONE]: [Taxonomy.COUNTRY_CODE],
        [Taxonomy.COUNTRY_CODE]: [Taxonomy.PHONE],
      };
      return relations[type] || [];
    }

    function fillField(element, value) {
      try {
        if (element.tagName === 'SELECT') {
          for (const opt of element.options) {
            if (opt.value.toLowerCase() === value.toLowerCase() || 
                opt.textContent.toLowerCase().includes(value.toLowerCase())) {
              element.value = opt.value;
              element.dispatchEvent(new Event('change', { bubbles: true }));
              return true;
            }
          }
          return false;
        }
        
        if (element.type === 'radio') {
          const radios = document.querySelectorAll(`input[name="${element.name}"]`);
          for (const radio of radios) {
            const radioLabel = radio.closest('label')?.textContent?.toLowerCase() || radio.value.toLowerCase();
            if (radioLabel.includes(value.toLowerCase()) || value.toLowerCase().includes(radioLabel)) {
              radio.checked = true;
              radio.dispatchEvent(new Event('change', { bubbles: true }));
              return true;
            }
          }
          return false;
        }
        
        if (element.type === 'checkbox') {
          const shouldCheck = ['yes', 'true', '1'].includes(value.toLowerCase());
          if (element.checked !== shouldCheck) {
            element.click();
          }
          return true;
        }
        
        const nativeSetter = Object.getOwnPropertyDescriptor(HTMLInputElement.prototype, 'value')?.set;
        if (nativeSetter) {
          nativeSetter.call(element, value);
        } else {
          element.value = value;
        }
        element.dispatchEvent(new Event('input', { bubbles: true }));
        element.dispatchEvent(new Event('change', { bubbles: true }));
        return true;
      } catch (e) {
        console.error('Fill error:', e);
        return false;
      }
    }

    function handleUndo() {
      for (const { element, previousValue } of fillHistory) {
        if (element.type === 'checkbox') {
          element.checked = previousValue;
        } else {
          element.value = previousValue || '';
        }
        element.dispatchEvent(new Event('change', { bubbles: true }));
      }
      removeBadges();
      document.getElementById('btn-undo').classList.add('hidden');
      showToast(`Undone ${fillHistory.length} fields`, 'info');
      fillHistory = [];
    }

    function clearForm() {
      document.getElementById('demo-form').querySelectorAll('input, select').forEach(el => {
        if (el.type === 'checkbox' || el.type === 'radio') {
          el.checked = false;
        } else {
          el.value = '';
        }
      });
      pendingObservations = [];
      updatePendingUI();
      removeBadges();
    }

    // ==================== BADGES ====================
    function showBadge(element, type, suggestions = []) {
      if (formOnlyMode) return;
      
      const wrapper = element.closest('.field-wrapper');
      if (!wrapper) return;
      
      const existing = wrapper.querySelector('.field-badge');
      if (existing) existing.remove();
      
      const badge = document.createElement('div');
      badge.className = 'field-badge px-2 py-1 rounded-full text-xs flex items-center gap-1 animate-fadeIn';
      
      if (type === 'filled' || type === 'transformed') {
        badge.classList.add('badge-filled');
        badge.innerHTML = type === 'transformed' 
          ? '<span>Transformed</span>' 
          : '<span>Filled</span>';
      } else if (type === 'suggest') {
        badge.classList.add('badge-suggest');
        badge.innerHTML = '<span>Suggest</span>';
        for (const s of suggestions.slice(0, 1)) {
          const btn = document.createElement('button');
          btn.className = 'ml-1 px-1.5 py-0.5 bg-blue-200 hover:bg-blue-300 rounded';
          btn.textContent = s.display?.slice(0, 15) || s.value?.slice(0, 15);
          btn.onclick = () => {
            fillField(element, s.value);
            showBadge(element, 'filled');
          };
          badge.appendChild(btn);
        }
      } else if (type === 'sensitive') {
        badge.classList.add('badge-sensitive');
        badge.innerHTML = '<span>Sensitive</span>';
      } else if (type === 'pending') {
        badge.classList.add('badge-pending');
        badge.innerHTML = '<span>Pending</span>';
      }
      
      wrapper.appendChild(badge);
    }

    function removeBadges(type = null) {
      const selector = type ? `.field-badge.badge-${type}` : '.field-badge';
      document.querySelectorAll(selector).forEach(b => b.remove());
    }

    // ==================== TOAST ====================
    let toastId = 0;
    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const id = ++toastId;
      const colors = { success: 'bg-green-600', info: 'bg-blue-600', warning: 'bg-amber-500', error: 'bg-red-600' };
      
      const toast = document.createElement('div');
      toast.id = `toast-${id}`;
      toast.className = `px-4 py-3 rounded-xl shadow-lg ${colors[type]} text-white text-sm animate-toastIn flex items-center justify-between`;
      toast.innerHTML = `<span>${message}</span><button onclick="removeToast(${id})" class="ml-3 opacity-70 hover:opacity-100">×</button>`;
      
      container.appendChild(toast);
      setTimeout(() => removeToast(id), 4000);
    }

    function removeToast(id) {
      const toast = document.getElementById(`toast-${id}`);
      if (toast) {
        toast.classList.add('animate-toastOut');
        setTimeout(() => toast.remove(), 300);
      }
    }

    // ==================== ACTIVITY LOG ====================
    function logActivity(type, data = {}) {
      const log = document.getElementById('activity-log');
      const entry = document.createElement('div');
      entry.className = 'p-2 rounded-lg border text-xs animate-slideIn';
      
      const icons = { profile: '📥', commit: '💾', fill: '✅', track: '📝' };
      const colors = { profile: 'border-purple-200 bg-purple-50', commit: 'border-green-200 bg-green-50', fill: 'border-blue-200 bg-blue-50', track: 'border-gray-200 bg-gray-50' };
      
      entry.classList.add(...(colors[type] || 'border-gray-200').split(' '));
      
      const time = new Date().toLocaleTimeString();
      let content = `<div class="flex items-center gap-1 text-gray-600"><span>${icons[type] || '•'}</span><span class="font-medium">${type}</span><span class="ml-auto text-gray-400">${time}</span></div>`;
      
      for (const [key, value] of Object.entries(data)) {
        content += `<div class="text-gray-500 mt-1">${key}: ${value}</div>`;
      }
      
      entry.innerHTML = content;
      log.insertBefore(entry, log.firstChild);
      
      while (log.children.length > 30) log.removeChild(log.lastChild);
    }

    function clearLogs() {
      document.getElementById('activity-log').innerHTML = '';
    }

    // ==================== FORM RENDERING ====================
    function renderField(field) {
      const wrapper = document.createElement('div');
      wrapper.className = 'field-wrapper relative';
      
      // Clear button (shown on hover)
      const clearBtn = document.createElement('button');
      clearBtn.type = 'button';
      clearBtn.className = 'clear-btn absolute right-2 top-1/2 -translate-y-1/2 w-5 h-5 rounded-full bg-gray-200 hover:bg-red-200 text-gray-500 hover:text-red-600 text-xs flex items-center justify-center z-20';
      clearBtn.innerHTML = '×';
      clearBtn.onclick = (e) => {
        e.preventDefault();
        const input = wrapper.querySelector('input, select, textarea');
        if (input) {
          if (input.type === 'checkbox' || input.type === 'radio') {
            input.checked = false;
          } else {
            input.value = '';
          }
          input.dispatchEvent(new Event('change', { bubbles: true }));
          const badge = wrapper.querySelector('.field-badge');
          if (badge) badge.remove();
        }
      };
      
      let html = '';
      
      if (field.type === 'radio') {
        html = `
          <label class="block text-sm font-medium text-gray-700 mb-2">${field.label}${field.required ? ' *' : ''}</label>
          <div class="space-y-1.5">
            ${field.options.map(opt => `
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="${field.name}" value="${opt.toLowerCase()}" class="form-radio" data-taxonomy="${field.taxonomy || ''}">
                <span class="text-sm">${opt}</span>
              </label>
            `).join('')}
          </div>
        `;
      } else if (field.type === 'checkbox') {
        html = `
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" name="${field.name}" class="form-checkbox" data-taxonomy="${field.taxonomy || ''}">
            <span class="text-sm">${field.label}</span>
          </label>
        `;
      } else if (field.type === 'select') {
        html = `
          <label class="block text-sm font-medium text-gray-700 mb-1">${field.label}${field.required ? ' *' : ''}</label>
          <select name="${field.name}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 pr-8" data-taxonomy="${field.taxonomy || ''}">
            ${field.options.map(opt => `<option value="${opt.toLowerCase()}">${opt || 'Select...'}</option>`).join('')}
          </select>
        `;
      } else {
        html = `
          <label class="block text-sm font-medium text-gray-700 mb-1">${field.label}${field.required ? ' *' : ''}</label>
          <input type="${field.type}" name="${field.name}" 
            ${field.placeholder ? `placeholder="${field.placeholder}"` : ''}
            ${field.maxlength ? `maxlength="${field.maxlength}"` : ''}
            ${field.required ? 'required' : ''}
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 pr-8"
            data-taxonomy="${field.taxonomy || ''}">
        `;
      }
      
      wrapper.innerHTML = html;
      
      // Add clear button for non-radio fields
      if (field.type !== 'radio') {
        wrapper.appendChild(clearBtn);
      }
      
      // Store field definition on element
      const input = wrapper.querySelector('input, select, textarea');
      if (input) {
        input._fieldDef = field;
        
        // Track on blur/change for two-phase save
        input.addEventListener('blur', () => {
          if (input.value || input.checked) {
            trackPendingObservation(input, input.type === 'checkbox' ? (input.checked ? 'yes' : 'no') : input.value, field);
          }
        });
        input.addEventListener('change', () => {
          if (input.type === 'radio' || input.type === 'checkbox' || input.tagName === 'SELECT') {
            if (input.value || input.checked) {
              trackPendingObservation(input, input.type === 'checkbox' ? (input.checked ? 'yes' : 'no') : input.value, field);
            }
          }
        });
      }
      
      return wrapper;
    }

    function loadTemplate(name) {
      const template = TEMPLATES[name];
      if (!template) return;
      
      document.querySelectorAll('.template-btn').forEach(btn => {
        btn.classList.remove('border-blue-500', 'bg-blue-50', 'text-blue-700');
        btn.classList.add('border-gray-200');
      });
      document.querySelector(`[data-template="${name}"]`)?.classList.add('border-blue-500', 'bg-blue-50', 'text-blue-700');
      
      document.getElementById('form-title').textContent = template.title;
      document.getElementById('form-subtitle').textContent = template.subtitle;
      
      const form = document.getElementById('demo-form');
      form.innerHTML = '';
      
      let fieldCount = 0;
      pendingObservations = [];
      updatePendingUI();
      
      if (template.sections) {
        for (const section of template.sections) {
          const fieldset = document.createElement('fieldset');
          fieldset.className = 'border border-gray-200 rounded-lg p-4 mb-4';
          fieldset.innerHTML = `<legend class="text-sm font-semibold text-gray-600 px-2">${section.title}</legend>`;
          
          const container = document.createElement('div');
          container.className = 'space-y-4 mt-2';
          
          for (const field of section.fields) {
            container.appendChild(renderField(field));
            fieldCount++;
          }
          
          fieldset.appendChild(container);
          form.appendChild(fieldset);
        }
      } else if (template.fields) {
        const container = document.createElement('div');
        container.className = 'space-y-4';
        for (const field of template.fields) {
          container.appendChild(renderField(field));
          fieldCount++;
        }
        form.appendChild(container);
      }
      
      document.getElementById('field-count').textContent = fieldCount;
      removeBadges();
      logActivity('template', { name, fields: fieldCount });
    }

    // ==================== ANSWERS EDITOR ====================
    function renderAnswersEditor() {
      const container = document.getElementById('answers-editor');
      const answers = Object.values(savedAnswers);
      
      document.getElementById('answer-count').textContent = `${answers.length} items`;
      
      if (answers.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">No saved answers.<br>Load a profile or fill forms.</p>';
        return;
      }
      
      container.innerHTML = '';
      
      for (const answer of answers) {
        const item = document.createElement('div');
        item.className = 'p-2 bg-gray-50 rounded-lg';
        item.innerHTML = `
          <div class="flex items-center justify-between">
            <span class="text-xs text-gray-400">${answer.type}</span>
            <button onclick="deleteAnswer('${answer.type}')" class="text-gray-400 hover:text-red-500 text-xs">×</button>
          </div>
          <input type="text" value="${answer.value}" 
            onchange="updateAnswer('${answer.type}', this.value)"
            class="w-full text-sm bg-transparent border-0 p-0 mt-1 focus:ring-0">
        `;
        container.appendChild(item);
      }
    }

    function updateAnswer(type, value) {
      if (savedAnswers[type]) {
        savedAnswers[type].value = value;
        savedAnswers[type].display = value;
        saveAnswers();
      }
    }

    function deleteAnswer(type) {
      delete savedAnswers[type];
      saveAnswers();
    }

    let formOnlyMode = localStorage.getItem('demo_form_only') === 'true';
    
    function toggleDemoMode() {
      formOnlyMode = !formOnlyMode;
      localStorage.setItem('demo_form_only', formOnlyMode);
      applyDemoMode();
    }
    
    function applyDemoMode() {
      const leftPanel = document.getElementById('left-panel');
      const rightPanel = document.getElementById('right-panel');
      const demoWidget = document.getElementById('demo-floating-widget');
      const statsPanel = document.getElementById('stats-panel');
      const pendingNotice = document.getElementById('pending-notice');
      const toggleText = document.getElementById('toggle-text');
      const iconExpand = document.getElementById('toggle-icon-expand');
      const iconCollapse = document.getElementById('toggle-icon-collapse');
      
      if (formOnlyMode) {
        leftPanel.classList.add('hidden');
        rightPanel.classList.add('hidden');
        demoWidget.classList.add('hidden');
        if (statsPanel) statsPanel.classList.add('hidden');
        if (pendingNotice) pendingNotice.classList.add('hidden');
        removeBadges();
        toggleText.textContent = 'Show Demo UI';
        iconExpand.classList.remove('hidden');
        iconCollapse.classList.add('hidden');
      } else {
        leftPanel.classList.remove('hidden');
        rightPanel.classList.remove('hidden');
        demoWidget.classList.remove('hidden');
        if (statsPanel) statsPanel.classList.remove('hidden');
        toggleText.textContent = 'Form Only';
        iconExpand.classList.add('hidden');
        iconCollapse.classList.remove('hidden');
      }
    }

    // ==================== SIDE PANEL TABS ====================
    let currentSideTab = 'database';
    let aiEnabled = false;
    let typingAnimEnabled = true;

    function switchSideTab(tabName) {
      currentSideTab = tabName;

      // Update tab buttons
      document.querySelectorAll('.side-tab').forEach(tab => {
        if (tab.dataset.tab === tabName) {
          tab.classList.add('text-blue-600', 'border-blue-600', 'bg-blue-50/50');
          tab.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:bg-gray-50', 'border-transparent');
        } else {
          tab.classList.remove('text-blue-600', 'border-blue-600', 'bg-blue-50/50');
          tab.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:bg-gray-50', 'border-transparent');
        }
      });

      // Update tab content
      document.querySelectorAll('.side-tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      document.getElementById(`tab-${tabName}`).classList.remove('hidden');
    }

    function renderDatabaseItems() {
      const container = document.getElementById('database-items');
      const answers = Object.values(savedAnswers);
      const searchTerm = document.getElementById('db-search')?.value?.toLowerCase() || '';

      // Update stats
      document.getElementById('stat-answers').textContent = answers.length;
      document.getElementById('stat-work').textContent = '0';  // Demo placeholder
      document.getElementById('stat-edu').textContent = '0';   // Demo placeholder

      // Filter by search
      const filtered = searchTerm
        ? answers.filter(a =>
            a.type.toLowerCase().includes(searchTerm) ||
            a.value.toLowerCase().includes(searchTerm))
        : answers;

      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8">
            <svg class="w-12 h-12 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
            </svg>
            <p class="text-sm text-gray-400">${searchTerm ? 'No results found' : 'No saved answers'}</p>
            <p class="text-xs text-gray-300 mt-1">${searchTerm ? 'Try a different search' : 'Load a profile to get started'}</p>
          </div>
        `;
        return;
      }

      container.innerHTML = '';

      // Group by category
      const personal = filtered.filter(a => ['FULL_NAME', 'FIRST_NAME', 'LAST_NAME', 'EMAIL', 'PHONE', 'CITY', 'LOCATION'].includes(a.type));
      const links = filtered.filter(a => ['LINKEDIN', 'GITHUB', 'PORTFOLIO'].includes(a.type));
      const education = filtered.filter(a => ['SCHOOL', 'DEGREE', 'MAJOR', 'GRAD_DATE', 'GRAD_YEAR', 'GRAD_MONTH'].includes(a.type));
      const work = filtered.filter(a => ['WORK_AUTH', 'NEED_SPONSORSHIP'].includes(a.type));
      const other = filtered.filter(a => !personal.includes(a) && !links.includes(a) && !education.includes(a) && !work.includes(a));

      const renderGroup = (title, items, icon) => {
        if (items.length === 0) return '';
        const itemsHtml = items.map(a => `
          <div class="flex items-center justify-between py-1.5 px-2 hover:bg-gray-50 rounded group">
            <div class="min-w-0 flex-1">
              <span class="text-[10px] text-gray-400 block">${a.type}</span>
              <span class="text-xs text-gray-700 truncate block">${a.display || a.value}</span>
            </div>
            <button onclick="deleteAnswer('${a.type}')" class="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity ml-2">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>
        `).join('');

        return `
          <div class="mb-3">
            <div class="flex items-center gap-1.5 mb-1.5 px-1">
              ${icon}
              <span class="text-xs font-medium text-gray-600">${title}</span>
              <span class="text-[10px] text-gray-400">(${items.length})</span>
            </div>
            <div class="bg-gray-50 rounded-lg divide-y divide-gray-100">
              ${itemsHtml}
            </div>
          </div>
        `;
      };

      container.innerHTML =
        renderGroup('Personal', personal, '<svg class="w-3.5 h-3.5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>') +
        renderGroup('Links', links, '<svg class="w-3.5 h-3.5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>') +
        renderGroup('Education', education, '<svg class="w-3.5 h-3.5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 14l9-5-9-5-9 5 9 5z"/><path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"/></svg>') +
        renderGroup('Work', work, '<svg class="w-3.5 h-3.5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>') +
        renderGroup('Other', other, '<svg class="w-3.5 h-3.5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z"/></svg>');
    }

    function filterDatabaseItems() {
      renderDatabaseItems();
    }

    function toggleAiEnhancement() {
      aiEnabled = !aiEnabled;
      const toggle = document.getElementById('ai-toggle');
      const knob = toggle.querySelector('span');
      if (aiEnabled) {
        toggle.classList.add('bg-blue-600');
        toggle.classList.remove('bg-gray-200');
        knob.classList.add('translate-x-4');
        knob.classList.remove('translate-x-0');
        showToast('AI Enhancement enabled (demo)', 'success');
      } else {
        toggle.classList.remove('bg-blue-600');
        toggle.classList.add('bg-gray-200');
        knob.classList.remove('translate-x-4');
        knob.classList.add('translate-x-0');
        showToast('AI Enhancement disabled', 'info');
      }
    }

    function toggleTypingAnimation() {
      typingAnimEnabled = !typingAnimEnabled;
      const toggle = document.getElementById('anim-toggle');
      const knob = toggle.querySelector('span');
      if (typingAnimEnabled) {
        toggle.classList.add('bg-blue-600');
        toggle.classList.remove('bg-gray-200');
        knob.classList.add('translate-x-4');
        knob.classList.remove('translate-x-0');
      } else {
        toggle.classList.remove('bg-blue-600');
        toggle.classList.add('bg-gray-200');
        knob.classList.remove('translate-x-4');
        knob.classList.add('translate-x-0');
      }
    }

    // Override saveAnswers to also update database panel
    const originalSaveAnswers = saveAnswers;
    saveAnswers = function() {
      localStorage.setItem('autofiller_v2_answers', JSON.stringify(savedAnswers));
      renderAnswersEditor();
      renderDatabaseItems();
    };

    loadAnswers();
    renderDatabaseItems();
    loadTemplate('full');
    applyDemoMode();
  </script>
</body>
</html>
